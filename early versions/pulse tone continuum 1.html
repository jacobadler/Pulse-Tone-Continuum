<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Pulse–Tone Continuum</title>
<style>
  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

  body {
    background: #0a0a0f;
    color: #e0e0e8;
    font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
    display: flex;
    justify-content: center;
    align-items: center;
    min-height: 100vh;
    overflow: hidden;
  }

  .container {
    width: 480px;
    max-width: 95vw;
    display: flex;
    flex-direction: column;
    gap: 32px;
    align-items: center;
  }

  /* --- Top Controls --- */
  .controls-row {
    display: flex;
    gap: 16px;
    width: 100%;
    align-items: flex-start;
  }

  .input-group {
    display: flex;
    flex-direction: column;
    gap: 6px;
    flex: 1;
  }

  label {
    font-size: 11px;
    text-transform: uppercase;
    letter-spacing: 0.08em;
    color: #888;
  }

  input[type="text"], select {
    background: #16161e;
    border: 1px solid #2a2a3a;
    border-radius: 6px;
    color: #e0e0e8;
    font-family: 'Consolas', 'SF Mono', monospace;
    font-size: 15px;
    padding: 10px 12px;
    outline: none;
    transition: border-color 0.15s;
  }

  input[type="text"]:focus, select:focus {
    border-color: #5a5aff;
  }

  input[type="text"].error {
    border-color: #ff4444;
  }

  .error-msg {
    font-size: 11px;
    color: #ff4444;
    min-height: 16px;
  }

  select {
    cursor: pointer;
    appearance: none;
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='10' height='6'%3E%3Cpath d='M0 0l5 6 5-6z' fill='%23888'/%3E%3C/svg%3E");
    background-repeat: no-repeat;
    background-position: right 12px center;
    padding-right: 32px;
  }

  /* --- Slider --- */
  .slider-section {
    width: 100%;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 12px;
  }

  .slider-track {
    width: 100%;
    height: 56px;
    position: relative;
    display: flex;
    align-items: center;
  }

  input[type="range"] {
    -webkit-appearance: none;
    appearance: none;
    width: 100%;
    height: 6px;
    background: linear-gradient(90deg, #2a2a4a, #5a5aff);
    border-radius: 3px;
    outline: none;
    cursor: pointer;
  }

  input[type="range"]::-webkit-slider-thumb {
    -webkit-appearance: none;
    width: 24px;
    height: 24px;
    border-radius: 50%;
    background: #e0e0e8;
    box-shadow: 0 0 10px rgba(90, 90, 255, 0.5);
    cursor: grab;
  }

  input[type="range"]::-moz-range-thumb {
    width: 24px;
    height: 24px;
    border-radius: 50%;
    background: #e0e0e8;
    box-shadow: 0 0 10px rgba(90, 90, 255, 0.5);
    border: none;
    cursor: grab;
  }

  input[type="range"]:active::-webkit-slider-thumb { cursor: grabbing; }
  input[type="range"]:active::-moz-range-thumb { cursor: grabbing; }

  .slider-labels {
    width: 100%;
    display: flex;
    justify-content: space-between;
    font-size: 10px;
    color: #555;
    text-transform: uppercase;
    letter-spacing: 0.06em;
  }

  /* --- Frequency Display --- */
  .freq-display {
    font-family: 'Consolas', 'SF Mono', monospace;
    font-size: 32px;
    font-weight: 300;
    letter-spacing: -0.02em;
    color: #c0c0ff;
  }

  .freq-unit {
    font-size: 14px;
    color: #666;
    margin-left: 4px;
  }

  /* --- Start Button --- */
  .start-btn {
    background: #5a5aff;
    border: none;
    color: #fff;
    font-family: inherit;
    font-size: 13px;
    text-transform: uppercase;
    letter-spacing: 0.1em;
    padding: 10px 32px;
    border-radius: 6px;
    cursor: pointer;
    transition: background 0.15s;
  }

  .start-btn:hover { background: #4a4ae8; }
  .start-btn.active { background: #ff4466; }
  .start-btn.active:hover { background: #e83355; }
</style>
</head>
<body>

<div class="container">
  <div class="controls-row">
    <div class="input-group" style="flex:2">
      <label for="ratioInput">Enter Ratio (e.g., 3:2 or 7:5:4)</label>
      <input type="text" id="ratioInput" value="3:2" spellcheck="false" autocomplete="off">
      <div class="error-msg" id="ratioError"></div>
    </div>
    <div class="input-group" style="flex:1">
      <label for="timbreSelect">Timbre</label>
      <select id="timbreSelect">
        <option value="sine">sine</option>
        <option value="square">square</option>
        <option value="triangle">triangle</option>
        <option value="sawtooth">sawtooth</option>
        <option value="click">click</option>
      </select>
    </div>
  </div>

  <div class="slider-section">
    <div class="slider-track">
      <input type="range" id="freqSlider" min="0" max="1" step="0.001" value="0.5">
    </div>
    <div class="slider-labels">
      <span>Pulse</span>
      <span>Tone</span>
    </div>
  </div>

  <div class="freq-display">
    <span id="freqValue">31.62</span><span class="freq-unit">Hz</span>
  </div>

  <button class="start-btn" id="startBtn">Start</button>
</div>

<script>
// ============================================================
//  parseRatio — validate and normalize colon-separated integers
// ============================================================
function parseRatio(str) {
  const trimmed = str.trim();
  if (!trimmed) return { error: 'Enter a ratio' };

  const parts = trimmed.split(':');
  if (parts.length < 1 || parts.length > 8)
    return { error: 'Use 1–8 colon-separated values' };

  const nums = [];
  for (const p of parts) {
    if (!/^\d+$/.test(p.trim()))
      return { error: 'Positive integers only' };
    const n = parseInt(p.trim(), 10);
    if (n <= 0) return { error: 'No zeros allowed' };
    nums.push(n);
  }

  // Normalize by GCD
  const gcd = (a, b) => (b === 0 ? a : gcd(b, a % b));
  const overall = nums.reduce((a, b) => gcd(a, b));
  const normalized = nums.map(n => n / overall);

  return { values: normalized };
}

// ============================================================
//  Frequency mapping — log scale from slider position [0,1]
// ============================================================
const FREQ_MIN = 0.25;
const FREQ_MAX = 4000;

function sliderToFreq(t) {
  return FREQ_MIN * Math.pow(FREQ_MAX / FREQ_MIN, t);
}

function formatFreq(f) {
  if (f < 10) return f.toFixed(2);
  if (f < 100) return f.toFixed(1);
  return Math.round(f).toString();
}

// ============================================================
//  Audio Engine
// ============================================================
function createAudioEngine() {
  let ctx = null;
  let masterGain = null;
  let limiter = null;
  let voices = [];         // { osc, gain } or { scriptInterval, gain } for click
  let currentRatio = [3, 2];
  let currentTimbre = 'sine';
  let currentBaseFreq = 31.62;
  let running = false;

  function ensureContext() {
    if (!ctx) {
      ctx = new (window.AudioContext || window.webkitAudioContext)();
      // Soft limiter via DynamicsCompressor
      limiter = ctx.createDynamicsCompressor();
      limiter.threshold.value = -3;
      limiter.knee.value = 6;
      limiter.ratio.value = 12;
      limiter.attack.value = 0.002;
      limiter.release.value = 0.05;
      limiter.connect(ctx.destination);

      masterGain = ctx.createGain();
      masterGain.gain.value = 0;
      masterGain.connect(limiter);
    }
    if (ctx.state === 'suspended') ctx.resume();
  }

  // Destroy all current voices
  function destroyVoices() {
    for (const v of voices) {
      try {
        if (v.osc) {
          v.osc.stop();
          v.osc.disconnect();
        }
        if (v.clickInterval != null) {
          clearInterval(v.clickInterval);
        }
        if (v.gain) v.gain.disconnect();
      } catch (_) {}
    }
    voices = [];
  }

  // Schedule a single click impulse
  function scheduleClick(gainNode, time) {
    const buf = ctx.createBuffer(1, Math.max(1, Math.ceil(ctx.sampleRate * 0.004)), ctx.sampleRate);
    const data = buf.getChannelData(0);
    for (let i = 0; i < data.length; i++) {
      data[i] = Math.exp(-i / (ctx.sampleRate * 0.001));
    }
    const src = ctx.createBufferSource();
    src.buffer = buf;
    src.connect(gainNode);
    src.start(time);
  }

  // Build click voice — uses setInterval to schedule bursts
  function createClickVoice(freq, voiceGain) {
    const gain = ctx.createGain();
    gain.gain.value = voiceGain;
    gain.connect(masterGain);

    // Schedule clicks at the given frequency rate
    let lastClick = ctx.currentTime;
    scheduleClick(gain, lastClick);

    const interval = setInterval(() => {
      if (!running) return;
      const now = ctx.currentTime;
      const period = 1 / freq;
      // Schedule a batch of clicks slightly ahead
      while (lastClick + period <= now + 0.1) {
        lastClick += period;
        if (lastClick > now - 0.01) {
          scheduleClick(gain, Math.max(lastClick, now));
        }
      }
    }, 50);

    return { clickInterval: interval, gain, _freq: freq };
  }

  // Build oscillator voices from ratio + base freq
  function rebuildOscillators() {
    destroyVoices();
    if (!running) return;

    const n = currentRatio.length;
    const rMin = Math.min(...currentRatio);
    const voiceGain = 1 / n;
    const startTime = ctx.currentTime + 0.005; // tiny offset for alignment

    for (let i = 0; i < n; i++) {
      const freq = currentBaseFreq * (currentRatio[i] / rMin);

      if (currentTimbre === 'click') {
        voices.push(createClickVoice(freq, voiceGain));
      } else {
        const osc = ctx.createOscillator();
        osc.type = currentTimbre;
        osc.frequency.value = freq;

        const gain = ctx.createGain();
        gain.gain.value = voiceGain;

        osc.connect(gain);
        gain.connect(masterGain);
        osc.start(startTime); // phase-aligned common start
        voices.push({ osc, gain });
      }
    }
  }

  // Smoothly update frequencies without rebuilding (oscillator modes only)
  function updateFrequencies(baseFreq) {
    currentBaseFreq = baseFreq;
    if (!running || voices.length === 0) return;

    const rMin = Math.min(...currentRatio);
    const now = ctx.currentTime;

    for (let i = 0; i < voices.length; i++) {
      const freq = baseFreq * (currentRatio[i] / rMin);
      const v = voices[i];
      if (v.osc) {
        v.osc.frequency.setTargetAtTime(freq, now, 0.02);
      } else if (v.clickInterval != null) {
        // For click, we need to rebuild since interval timing changes
        v._freq = freq;
      }
    }

    // Click timbre needs rebuild for frequency changes
    if (currentTimbre === 'click') {
      rebuildOscillators();
    }
  }

  function setRatio(ratio) {
    currentRatio = ratio;
    if (running) rebuildOscillators();
  }

  function setTimbre(timbre) {
    currentTimbre = timbre;
    if (running) rebuildOscillators();
  }

  function start() {
    ensureContext();
    running = true;
    masterGain.gain.setTargetAtTime(1, ctx.currentTime, 0.02);
    rebuildOscillators();
  }

  function stop() {
    running = false;
    if (masterGain) {
      masterGain.gain.setTargetAtTime(0, ctx.currentTime, 0.02);
    }
    // Destroy after fade
    setTimeout(destroyVoices, 80);
  }

  return { start, stop, setRatio, setTimbre, updateFrequencies, isRunning: () => running };
}

// ============================================================
//  UI Controller
// ============================================================
function uiController() {
  const ratioInput  = document.getElementById('ratioInput');
  const ratioError  = document.getElementById('ratioError');
  const timbreSelect = document.getElementById('timbreSelect');
  const freqSlider  = document.getElementById('freqSlider');
  const freqValue   = document.getElementById('freqValue');
  const startBtn    = document.getElementById('startBtn');

  const engine = createAudioEngine();
  let currentRatio = [3, 2];

  // --- Ratio input ---
  function handleRatioChange() {
    const result = parseRatio(ratioInput.value);
    if (result.error) {
      ratioInput.classList.add('error');
      ratioError.textContent = result.error;
      return;
    }
    ratioInput.classList.remove('error');
    ratioError.textContent = '';
    currentRatio = result.values;
    engine.setRatio(currentRatio);
  }

  ratioInput.addEventListener('input', handleRatioChange);

  // --- Timbre ---
  timbreSelect.addEventListener('change', () => {
    engine.setTimbre(timbreSelect.value);
  });

  // --- Slider ---
  function handleSlider() {
    const t = parseFloat(freqSlider.value);
    const freq = sliderToFreq(t);
    freqValue.textContent = formatFreq(freq);
    engine.updateFrequencies(freq);
  }

  freqSlider.addEventListener('input', handleSlider);
  // Initialize display
  handleSlider();

  // --- Start/Stop ---
  startBtn.addEventListener('click', () => {
    if (engine.isRunning()) {
      engine.stop();
      startBtn.textContent = 'Start';
      startBtn.classList.remove('active');
    } else {
      engine.start();
      startBtn.textContent = 'Stop';
      startBtn.classList.add('active');
    }
  });
}

// Boot
uiController();
</script>

</body>
</html>
